flowchart TD

%% === MAIN PROGRAM FLOW ===
subgraph MAIN["main() â€” Program Flow"]
    M0(["Start program"])
    M1["Read command-line arguments (argc, argv)"]
    M2{"Enough arguments provided?"}
    M2 -->|No| M3["Print usage message and exit"]
    M2 -->|Yes| M4["Extract filter_age_max, ifile, and ofile"]
    M5{"Is filter_age_max a valid number?"}
    M5 -->|No| M6["Print error and exit"]
    M5 -->|Yes| M7["Continue with file setup"]

    M8{"Was input file argument provided?"}
    M8 -->|Yes| M9["Try to open input file (fopen ifile, 'r')"]
    M8 -->|No| M13["Assign istream = stdin"]

    M10{"File opened successfully?"}
    M10 -->|No| M11["Handle error: cannot open input file"]
    M10 -->|Yes| M12["Assign istream = opened file"]

    M14{"Was output file argument provided?"}
    M14 -->|Yes| M15["Try to open output file (fopen ofile, 'w')"]
    M14 -->|No| M19["Assign ostream = stdout"]

    M16{"File opened successfully?"}
    M16 -->|No| M17["Handle error: cannot open output file"]
    M16 -->|Yes| M18["Assign ostream = opened file"]

    M20["Write short text block to output summarizing arguments used"]

    M21["Call filter_stream(istream, ostream)"]

    M22["Close istream and ostream"]
    M23(["End program"])

    M0 --> M1 --> M2
    M4 --> M5
    M7 --> M8
    M9 --> M10
    M12 --> M14
    M13 --> M14
    M15 --> M16
    M18 --> M20
    M19 --> M20
    M20 --> M21 --> M22 --> M23
end

%% === FILTER STREAM FUNCTION ===
subgraph FILTER["filter_stream(FILE *istream, FILE *ostream)"]
    F0(["Start filtering CSV stream"])
    F1["Initialize buffers: line, name, age_str"]
    F2["Set line_no = 0"]
    F3["Loop until end of istream (while !feof(istream))"]
    F4["Increment line number"]
    F5["Read next line with fgets(line, LINE_MAX, istream)"]

    F6{"Did fgets succeed and is the line non-empty?"}
    F6 -->|No| F7["Handle error (skip line)"]
    F6 -->|Yes| F8["Tokenize line by delimiter ',' using strtok()"]
    
    F9["Extract first token as name"]
    F10["Extract second token as age_str"]
    
    F11{"Were both tokens found?"}
    F11 -->|No| F12["Handle error (skip line)"]
    F11 -->|Yes| F13["Convert age_str to integer using sscanf()"]
    
    F14{"Was conversion successful?"}
    F14 -->|No| F15["Handle error (invalid age)"]
    
    F14 -->|Yes| F16{"Is age <= filter_age_max?"}
    F16 -->|No| F17["Skip line (too old)"]
    F16 -->|Yes| F18["Write name and age to ostream"]
    
    F19(["Repeat for next line"])

    F0 --> F1 --> F2 --> F3 --> F4 --> F5 --> F6
    F8 --> F9 --> F10 --> F11
    F13 --> F14
    F18 --> F19
    F15 --> F19
    F12 --> F19
    F7 --> F19
end

%% === RELATIONSHIP ===
MAIN -.-> FILTER